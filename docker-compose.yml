services:
  # Anvil - Local Ethereum node
  anvil:
    image: ghcr.io/foundry-rs/foundry:nightly-5b7e4cb3c882b28f3c32ba580de27ce7381f415a
    container_name: anvil
    ports:
      - "8545:8545"
    environment:
      - ANVIL_IP_ADDR=0.0.0.0
    entrypoint: ["/bin/sh", "-c"]
    command: ["anvil --host 0.0.0.0 --chain-id 31337 --block-time 1 --gas-limit 100000000"]
    restart: unless-stopped

  # Blockchain - Contract deployment
  blockchain:
    image: node:20-alpine
    container_name: blockchain
    working_dir: /blockchain
    volumes:
      - ./blockchain:/blockchain
    environment:
      - ANVIL_RPC_URL=http://anvil:8545
      - ADMIN_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - INITIAL_SUPPLY=1000000
      - REWARD_PER_MESSAGE=10
    depends_on:
      - anvil
    command: sh -c "npm install && tail -f /dev/null"
    restart: unless-stopped

  # Eclipse Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    restart: unless-stopped

  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    restart: unless-stopped

  # ASP.NET Core Backend
  backend:
    build:
      context: ./src/Backend
      dockerfile: Dockerfile
    container_name: backend
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - MongoDB__ConnectionString=mongodb://mongodb:27017
      - MongoDB__DatabaseName=SmartHome
      - Mqtt__Host=mosquitto
      - Mqtt__Port=1883
      - Mqtt__Topic=sensors/#
      - Blockchain__RpcUrl=http://anvil:8545
      - Blockchain__AdminPrivateKey=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
      - Blockchain__ChainId=31337
    volumes:
      - ./blockchain:/blockchain
    depends_on:
      - mongodb
      - mosquitto
      - anvil
      - blockchain
    restart: unless-stopped

  # Vue.js Frontend
  frontend:
    build:
      context: ./src/Frontend
      dockerfile: Dockerfile
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    restart: unless-stopped

  # Sensor Simulator
  simulator:
    build:
      context: ./src/Simulator
      dockerfile: Dockerfile
    container_name: simulator
    environment:
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
    depends_on:
      - mosquitto
    restart: unless-stopped
volumes:
  mongodb_data:
  mosquitto_data:
  mosquitto_log:
  blockchain_artifacts:
